# QG资金管理系统

### 2024.4.14

#### 建表思路

建立数据库建立了四张表

enterprise 表格用来存储企业的id(系统自动分配作为主键) 企业名称，企业人数，企业规模，企业方向，公开模式，总资金,以及是否被封禁

![image-20240415101357657](img\image-20240415101357657.png)

user 表格用来储存用户的id(系统自动分配作为主键)，用户名(唯一，用户自己输入)，用户姓名，用户密码,用户的头像url(系统会分配默认头像),手机号码，个人资金，以及是否为网站管理员(默认为no)，以及是否被封禁



![image-20240415101451039](img\image-20240415101451039.png)

relation 表格 用来存储用户与企业的关系 rid(系统自动分配) 用来存储每一个唯一的关系， 存储用户id 企业id 以及 用户是否为企业群组管理员 以此可以使得用户可以同时加入多个企业而非固定一个企业，以及企业分配的企业资金

![image-20240415101524876](img\image-20240415101524876.png)

transaction 用来存储流水信息，内置一个账单id(系统自动分配),以及支付者id，收款者id(均有一个用户id和企业id)两者不能同时为空,交易时间，金额，交易描述

![image-20240415101550819](img/image-20240415101550819.png)

用户需要自己的流水账可以通过查询u_payee和u_payer的条件进行查询并获取数据发送给前端展示数据

通过以下sql语句设置联合约束用户id和企业id不能同时为空

ALTER TABLE transaction ADD CONSTRAINT CheckNotEmptyUnique CHECK (u_payer IS NOT NULL OR e_payer IS NOT NULL);

---

#### 做出了整体架构

具体知道某一部应该如何做

![资金管理系统](资金管理系统思维导图.png)

思考了转账的具体实现过程

![image-20240414163837759](img\image-20240414163837759.png)

#### 做出了登录注册功能

同时用正则表达式判断输入是否合法，同时在注册新账户时候，用ajax异步请求调用数据库查询数据判断该用户名是否存在，并在非法输入的时候无法提交表单数据，并设置了游客登录的方式，游客登录到主界面后仅仅有查询公开企业的功能 和登录功能

![image-20240415101935290](img\image-20240415101935290.png)

![image-20240415102125843](img\image-20240415102125843.png)

#### 主界面

游客登录仅有登录功能与查询公开企业功能

普通用户登录则用户查询企业以及申请加入等功能

构思：通登录界面获取的表单数据来判断是否登录以及身份信息等

目前需要是通过登录界面提交表单跳转到主界面的，主界面网页有请求体的数据，但是目前不知道如何从网页中获取请求体数据

### 2024.4.15

#### 9：30承接昨天内容主界面

在登录界面已经主界面之间的用户信息，通过设置cookie将用户信息保存到客户端，以此来记录客户是否进行登录，以及辨别其身份等信息

要模拟两个用户之间的收付款可以通过开两个浏览器登录两个账户，不同浏览器的cookie并不相通，不使用session的原因是session是保存到服务端的，且会区分浏览器，但是存在多个用户用同一个浏览器登录账户的情况，这样session便无法辨别哪个用户登录的是哪个账户，易引起混乱，因此需要使用cookie将数据保存到客户的客户端更容易辨别账户信息

#### 11：00获取用户信息

判断是否为游客，用ajax发送异步请求查找是否登录，对div的内容进行更改增添一个登录超链接以便用户登录

![image-20240415114739669](img\image-20240415114739669.png)

若为普通用户，则增添一个查看个人信息的按钮以及，退出登录按钮，退出登录由弹窗确认，防止用户误点击。但是目前展示个人信息的页面尚未做出来(退出登录是与游客登录的代码逻辑相同，若存在username的cokkie则将其值改为空字符串,使得主界面无法获取到用户信息)

![image-20240415115219017](img\image-20240415115219017.png)

![image-20240415115351075](img\image-20240415115351075.png)

#### 12:40建立用户信息查询表

建立信息界面的时候发现用户的资金应该存在小数位，之前的简表不够严谨，因此将数据库中的long类型改成double类型,同时也更改了其他表中有关资金类型的数据均将long改成double类型

#### 14:30发现一处bug并修正

在注册账户界面发现手机号码并没有保存到数据库中使得数据库的信息不完整，通过debug的方式发现写错了某些变量值，并且发现html更改后重启服务器服务器的页面依旧没有发生改变，通过查阅资料得知可以使用CRIL+F5的方式强制刷新网页得以解决该问题

#### 15:39实现了用户个人信息查询的基本界面

![image-20240415154002361](img\image-20240415154002361.png)

设置了一个默认头像

#### 16:05设置了更改用户的界面并设置了正则表达式

用户可以选择更改信息或者不更改信息，更改信息则受到正则表达式的影响而进行规范的输入，若不更改的信息则不受正则表达式的影响，不会产生提示，在后端更改数据时面临问题，存在多个要更改的变量要判断前方是否存在更改的过程太过于繁琐，即前方有进行更改则需要在字符串前加一个逗号，判断条件过于繁琐![image-20240415202259215](img\image-20240415202259215.png)

#### 19：30对代码进行改进

由于无法使用mybatis框架 因此使用在第一个字段中 确定一个已知的值，即username = 原来的值然后后面需要更改的值统一加上逗号，可以减少繁琐的条件判断，在实现该想法之前先使用mysql进行尝试

![image-20240415202131578](img\image-20240415202131578.png)

通过mysql可以看出该想法确实可行因此对代码进行改进

#### 20：42用户信息更改

完成了对用户信息更改的代码测试，一切暂时还正常，但是还没搞出可以更改头像的代码,目前已知可以用file的type类型来选择文件，但是不知道如何获取选择文件的路径

通过查询资料知道可以通过JavaScript获取文件路径

![image-20240415210907464](img\image-20240415210907464.png)

可以通过这个代码来获取读取的文件路径(注意！！这里需要将jquery对象化作JavaScript对象，否则无法获取到文件路径)

实现如下：

![image-20240415211303183](img\image-20240415211303183.png)