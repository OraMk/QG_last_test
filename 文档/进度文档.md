# QG资金管理系统

### 2024.4.14

#### 建表思路

建立数据库建立了四张表

enterprise 表格用来存储企业的id(系统自动分配作为主键) 企业名称，企业人数，企业规模，企业方向，公开模式，总资金,以及是否被封禁

![image-20240415101357657](img\image-20240415101357657.png)

user 表格用来储存用户的id(系统自动分配作为主键)，用户名(唯一，用户自己输入)，用户姓名，用户密码,用户的头像url(系统会分配默认头像),手机号码，个人资金，以及是否为网站管理员(默认为no)，以及是否被封禁



![image-20240415101451039](img\image-20240415101451039.png)

relation 表格 用来存储用户与企业的关系 rid(系统自动分配) 用来存储每一个唯一的关系， 存储用户id 企业id 以及 用户是否为企业群组管理员 以此可以使得用户可以同时加入多个企业而非固定一个企业，以及企业分配的企业资金

![image-20240415101524876](img\image-20240415101524876.png)

transaction 用来存储流水信息，内置一个账单id(系统自动分配),以及支付者id，收款者id(均有一个用户id和企业id)两者不能同时为空,交易时间，金额，交易描述

![image-20240415101550819](img/image-20240415101550819.png)

用户需要自己的流水账可以通过查询u_payee和u_payer的条件进行查询并获取数据发送给前端展示数据

通过以下sql语句设置联合约束用户id和企业id不能同时为空

ALTER TABLE transaction ADD CONSTRAINT CheckNotEmptyUnique CHECK (u_payer IS NOT NULL OR e_payer IS NOT NULL);

---

#### 做出了整体架构

具体知道某一部应该如何做

![资金管理系统](资金管理系统思维导图.png)

思考了转账的具体实现过程

![image-20240414163837759](img\image-20240414163837759.png)

#### 做出了登录注册功能

同时用正则表达式判断输入是否合法，同时在注册新账户时候，用ajax异步请求调用数据库查询数据判断该用户名是否存在，并在非法输入的时候无法提交表单数据，并设置了游客登录的方式，游客登录到主界面后仅仅有查询公开企业的功能 和登录功能

![image-20240415101935290](img\image-20240415101935290.png)

![image-20240415102125843](img\image-20240415102125843.png)

#### 主界面

游客登录仅有登录功能与查询公开企业功能

普通用户登录则用户查询企业以及申请加入等功能

构思：通登录界面获取的表单数据来判断是否登录以及身份信息等

目前需要是通过登录界面提交表单跳转到主界面的，主界面网页有请求体的数据，但是目前不知道如何从网页中获取请求体数据

### 2024.4.15

#### 9：30承接昨天内容主界面

在登录界面已经主界面之间的用户信息，通过设置cookie将用户信息保存到客户端，以此来记录客户是否进行登录，以及辨别其身份等信息

要模拟两个用户之间的收付款可以通过开两个浏览器登录两个账户，不同浏览器的cookie并不相通，不使用session的原因是session是保存到服务端的，且会区分浏览器，但是存在多个用户用同一个浏览器登录账户的情况，这样session便无法辨别哪个用户登录的是哪个账户，易引起混乱，因此需要使用cookie将数据保存到客户的客户端更容易辨别账户信息

#### 11：00获取用户信息

判断是否为游客，用ajax发送异步请求查找是否登录，对div的内容进行更改增添一个登录超链接以便用户登录

![image-20240415114739669](img\image-20240415114739669.png)

若为普通用户，则增添一个查看个人信息的按钮以及，退出登录按钮，退出登录由弹窗确认，防止用户误点击。但是目前展示个人信息的页面尚未做出来(退出登录是与游客登录的代码逻辑相同，若存在username的cokkie则将其值改为空字符串,使得主界面无法获取到用户信息)

![image-20240415115219017](img\image-20240415115219017.png)

![image-20240415115351075](img\image-20240415115351075.png)

#### 12:40建立用户信息查询表

建立信息界面的时候发现用户的资金应该存在小数位，之前的简表不够严谨，因此将数据库中的long类型改成double类型,同时也更改了其他表中有关资金类型的数据均将long改成double类型

#### 14:30发现一处bug并修正

在注册账户界面发现手机号码并没有保存到数据库中使得数据库的信息不完整，通过debug的方式发现写错了某些变量值，并且发现html更改后重启服务器服务器的页面依旧没有发生改变，通过查阅资料得知可以使用CRIL+F5的方式强制刷新网页得以解决该问题

#### 15:39实现了用户个人信息查询的基本界面

![image-20240415154002361](img\image-20240415154002361.png)

设置了一个默认头像

#### 16:05设置了更改用户的界面并设置了正则表达式

用户可以选择更改信息或者不更改信息，更改信息则受到正则表达式的影响而进行规范的输入，若不更改的信息则不受正则表达式的影响，不会产生提示，在后端更改数据时面临问题，存在多个要更改的变量要判断前方是否存在更改的过程太过于繁琐，即前方有进行更改则需要在字符串前加一个逗号，判断条件过于繁琐![image-20240415202259215](img\image-20240415202259215.png)

#### 19：30对代码进行改进

由于无法使用mybatis框架 因此使用在第一个字段中 确定一个已知的值，即username = 原来的值然后后面需要更改的值统一加上逗号，可以减少繁琐的条件判断，在实现该想法之前先使用mysql进行尝试

![image-20240415202131578](img\image-20240415202131578.png)

通过mysql可以看出该想法确实可行因此对代码进行改进

#### 20：42用户信息更改

完成了对用户信息更改的代码测试，一切暂时还正常，但是还没搞出可以更改头像的代码,目前已知可以用file的type类型来选择文件，但是不知道如何获取选择文件的路径

通过查询资料知道可以通过JavaScript获取文件路径

![image-20240415210907464](img\image-20240415210907464.png)

可以通过这个代码来获取读取的文件路径(注意！！这里需要将jquery对象化作JavaScript对象，否则无法获取到文件路径)

实现如下：

![image-20240415211303183](img\image-20240415211303183.png)

#### 21：00头像更改实现

完成了头像更改的后端代码，并进行了代码调试，证明该后端代码目前可以满足更改头像的业余要求并将该数据保存到数据库中

#### 21：30发现bug

打脸瞬间，更改用户信息时候出现bug导致密码变成null 因为只判断是不是为null没有判断是否为空字符串，此后更改成功，解决一处bug。 

然而头像更改并无法持久保存本地文件的头像，重启服务器后图片无法加载出来，尝试修复bug

#### 22:00

打算暂时通过输入图片url的方式来更改头像修复该bug，后续有所更改再加以补充

![image-20240415221225803](img\image-20240415221225803.png)

重启服务器后发现可以成功保存头像并显示，暂时通过这个方式解决该头像更改的问题(后续有时间则重新改进一下)

![image-20240415221424948](img\image-20240415221424948.png)

#### 22:40

今日解决了主界面的设计以及代码实现，还有用户数据的更改和头像更改，修复了部分bug，解决了主界面如何获取用户数据的方式即cookie保存，明日计划完成企业功能的完成，包括：查看企业内容，加入企业，退出企业等功能，以及通过表格发生ajax发送异步请求给服务器查询所需要的企业，并完成主界面分页功能

### 2024.4.16实现企业界面展示以及加入企业功能 

#### 10:30

在思考查询企业详情时，发现并没有添加企业的介绍，因此考虑更改企业的表格添加一个基本介绍的column

#### 11:20

制作了查询企业数据的demo，后台已经成功获取并查询到结果并将结果集以json的方式发送给前端了，目前出现一个前端获取json数据的错误,暂时无法提取前端发送过来的json数据

#### 12：30

解决该问题用list集合传输json数据，属性名为pojo类中的属性名，因为没注意看导致出现错误，现在已经更正，能够正常提取企业数据了

现在打算在每一个企业后面设置按钮以此来查看企业的信息,

想法：通过给每个按钮设置一个class属性为research ， 可以通过jquery class选择器获取到该按钮，并且在该按钮的id设置为企业的id 获取按钮的同时可以获取到id并查询该企业的数据类型

#### 13:49企业信息表已经建立好

发现在主界面的查询按钮有问题，无法使用this.id()的方式获取id，导致按钮失效，开始尝试修复bug,查询遗漏点，$("#")中的this获取的是该按钮而不是按钮的jquery对象，需要用

```javascript
$(this).attr('id');来获取该按钮的id
```

#### 14:10

完成了对企业界面的完善，并且能够成功展示出企业数据，目前剩余加入企业的功能尚未完成，待完成

![image-20240416141800501](img\image-20240416141800501.png)

#### 16:30申请加入企业

在申请加入企业的程序中，思考到，需要创建一张表来存储该数据，以此使得管理员能够在需要的时候获取到该申请数据，因此新建一张申请表。同时想到发送转账请求也需要保存在一张表中，但是目前尚未做到该部分，尚且先不建立表格

![image-20240416155718529](img\image-20240416155718529.png)

建立了一个申请表格用来储存申请数据，并且有一个是否受理的column，以此来判断该申请是否成功受理

在申请加入企业的业务逻辑中，发现不仅需要判断该用户是否已经在该企业中，同时要判断该用户是否已经发送了一个未审理的请求，以防止一个用户发送了过多相同的请求导致数据库数据重复数据过多，数据过于冗余，因此在前端要用两个嵌套的ajax判断是否已经是该企业的成员以及发送申请加入企业的请求，后台则需要进行多重判断，保障数据的严谨可行。

#### 17:00完成了申请加入企业的代码逻辑

并且防止了用户多次发送请求导致服务器数据过大而崩溃，控制了数据库的稳定性

![image-20240416170632876](img\image-20240416170632876.png)

#### 17:40优化demo

发现只需要在加载界面的时候判断是否为成员以此来决定是否出现申请加入企业的选项，因此无需用两重ajax请求来判断，减少了代码的数量，并且在发现该用户是企业成员时提供一个退出企业的功能，并且有二次确认的窗口防止用户误触，退出企业后会重新加载页面，使得重新出现申请加入企业的功能

![image-20240416175208144](img\image-20240416175208144.png)

#### 18:00改进表格

发现企业成员需要拥有一个申请成为企业负责人的按钮，由于都是用户与企业之间的关系，因此更改先前创立的表格application 增添一个description的Column以此来描述该申请的类型

![image-20240416181117262](img\image-20240416181117262.png)

#### 20:00

实现了对企业用户申请成为企业负责人的按钮，并且后台方面也能实现该业务，业务逻辑与申请加入企业的逻辑相同，只是多添加了一个变量，更改了表格中描述的对象以便分辨申请类型并且能够分辨出是否为同一类型的申请，以防重复申请，引发数据库崩溃

#### 20:32

实现了对企业负责人与企业成员的分辨，企业负责人具有设置企业信息，分配企业资金的功能，而企业成员暂时没有.

![image-20240416203535245](img\image-20240416203535245.png)

#### 21:00设计修改企业信息页面



![image-20240416214515352](img\image-20240416214515352.png)

#### 21:30

根据测验发现企业修改信息的demo无问题，可以正常运行且可以更新数据

![image-20240416214503238](img\image-20240416214503238.png)

#### 21：47

给企业负责人增添一个可以查看申请的功能，以便增加新的企业负责人

目前该功能尚未成功

#### 22：20

本日完成了企业展示企业设置，已经不同企业用户进入企业界面的不同展示，并设置了申请进入企业的功能，但是查看申请功能已经审批功能尚未完成，明日完成审批功能，而后开始着手于转账功能。

### 2024.4.17

补充完成昨日未完成的查看申请功能以及审批功能，并着手于转账功能(感觉是最难的一部分)

#### 14:50

完成了申请功能的界面以及判断是哪个企业的申请功能，但是同意申请与拒绝接受申请功能尚未做成有待加强

![image-20240417153632689](img\image-20240417153632689.png)

#### 15:30

点击同意按钮后，要改变申请表中的数据，并且，后台要判断是为加入企业还是成为负责人的申请，根据不同的申请类型，对企业与用户表进行增添或者更改.

#### 15:55

发现先前建表是以企业与员工关系是以员工id和企业id进行保存的，然而在服务器中流动比较频繁的是员工的用户名，因此更改企业员工关系表为员工姓名与企业id的关系.

![image-20240417155547533](img\image-20240417155547533.png)

由于先前有使用过relation表格所以需要更改一些代码于先前的方法中

#### 16：30

完成了对申请类型的判断，以及申请加入企业的后台demo

并能使得负责人审理申请，并对数据库进行更新，完成业务需求(即申请加入企业则增添企业员工关系表，增添企业id 和员工信息这一栏目，而申请成为企业负责人则更改企业员工信息表，将对应企业的员工信息是否为负责人一项改为yes，因此加之身份为企业负责人)

![image-20240417172502282](img\image-20240417172502282.png)

![image-20240417172516159](img\image-20240417172516159.png)

还能查看以往已经审理过的申请，分开申请表的原因是以防历史申请数据过多，影响新申请的展示，影响审理申请的效率，因此分开两个申请表

![image-20240417172652769](img/image-20240417172652769.png)

#### 20：00

完成了对企业的查询功能，分页功能尚未完成，暂时先放一放，优先完成资金转账功能

![image-20240417200412235](img\image-20240417200412235.png)

同时也实现了注销企业的功能：展示如下，该注销企业的功能会将企业完全信息完全删除，并且企业与员工之间的关系信息 已经与该企业的请求均会删除。

![image-20240417201306635](img\image-20240417201306635.png)